---
import { getCollection } from 'astro:content';
import LayoutTemplate from './LayoutTemplate.astro';
import CategoryPostList from "../components/CategoryPostList.astro";
import countCategory  from "../utils/countCategory";

/* 
category [...slug] 에서 post를 props로 받아서 써도 되지만,
객체는 map으로 못돌리기 때문에 (PostListSection.astro에서) 그냥 getCollection으로 배열 받아와서 filter로 처리함. 
*/
const posts = await getCollection('blog');

const { slug } = Astro.params; 
const categoryData = posts.map(item => item.data.category);
const myCategory = posts.filter((post) => post.data.category === slug);

let categoryCountStore;
const categoryCountData = countCategory(categoryData);
const categoryCountDataFilter = Object.entries(categoryCountData).filter(([key,value]) => key === slug);
// console.log(categoryCountDataFilter);
categoryCountDataFilter.forEach(([key,value]) => (categoryCountStore = value));

// console.log(categoryCountStore);

const pathname = Astro.url.pathname;
// 받아온 pathname을 분해
const pathSegments = pathname.split('/');
// 마지막 pathname 값만 가져와서
const categoryLastUrl = pathSegments[pathSegments.length - 1];
// decode 후 저장~~
const decodeCategoryLastUrl = decodeURIComponent(categoryLastUrl);
---
<LayoutTemplate title={`${decodeCategoryLastUrl} 관련글`}>
    <CategoryPostList {myCategory} {decodeCategoryLastUrl} {categoryCountStore}>
        <slot/>
    </CategoryPostList>
</LayoutTemplate>