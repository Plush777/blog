---
import { getCollection } from 'astro:content';
import LayoutTemplate from './LayoutTemplate.astro';
import CategoryPostList from "../components/CategoryPostList.astro";
import countCategory  from "../utils/countCategory";
   
const posts = await getCollection('blog');

const { slug } = Astro.params; 
const categoryData = posts.map(item => item.data.category);
const myCategory = posts.filter((post) => post.data.category === slug);

let categoryCountStore;
const categoryCountData = countCategory(categoryData);
const categoryCountDataFilter = Object.entries(categoryCountData).filter(([key,value]) => key === slug);
// console.log(categoryCountDataFilter);
categoryCountDataFilter.forEach(([key,value]) => (categoryCountStore = value));

// console.log(categoryCountStore);

let myCategoryUrl;

const pathname = Astro.url.pathname;
const pathSegments = pathname.split('/');
const categoryLastUrl = pathSegments[pathSegments.length - 1];

if (categoryLastUrl === '') {
    pathSegments.pop();
    myCategoryUrl = pathSegments[pathSegments.length - 1];
} else {
    myCategoryUrl = categoryLastUrl;
}

const decodeCategoryLastUrl = decodeURIComponent(myCategoryUrl);
---
<LayoutTemplate title={`${decodeCategoryLastUrl} 관련글`}>
    <CategoryPostList {myCategory} {decodeCategoryLastUrl} {categoryCountStore}>
        <slot/>
    </CategoryPostList>
</LayoutTemplate>